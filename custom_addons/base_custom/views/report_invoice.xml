<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <template id="report_invoice_document_inherit_sale_inherited" inherit_id="sale.report_invoice_document_inherit_sale">
        <xpath expr="//div[@groups='sale.group_delivery_invoice_address']" position="replace">
            <div groups="sale.group_delivery_invoice_address">
                <strong>Adresse d'enlèvement / de livraison :</strong>
                <div t-field="o.partner_shipping_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
            </div>
        </xpath>
    </template>

    <template id="report_invoice_custom_inherit" inherit_id="account.report_invoice_document">

        <xpath expr="//tbody[hasclass('invoice_tbody')]" position="replace">
            <tbody class="invoice_tbody">
                <t t-set="current_subtotal" t-value="0"/>

                <t t-foreach="o.invoice_line_ids.sorted(key=lambda r: r.sequence)" t-as="line">

                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>

                    <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'o_line_note' if line.display_type == 'line_note' else ''">
                        <t t-if="not line.display_type" name="account_invoice_line_accountable">
                            <td name="account_invoice_line_name"><span t-field="line.name"/></td>
                            <td class="text-right">
                                <span t-field="line.quantity"/>
                                <span t-field="line.product_uom_id"  groups="uom.group_uom"/>
                            </td>
                            <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                <span t-field="line.price_unit"/>
                            </td>
                            <td t-if="display_discount" t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                <span t-field="line.discount"/>
                            </td>
                            <td t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_ids))" id="line_tax_ids"/>
                            </td>
                            <td class="text-right o_price_total">
                                <span t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                <span t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                            </td>
                        </t>
                        <t t-if="line.display_type == 'line_section'">
                            <td colspan="99">
                                <span t-field="line.name"/>
                            </td>
                            <t t-set="current_section" t-value="line"/>
                            <t t-set="current_subtotal" t-value="0"/>
                        </t>
                        <t t-if="line.display_type == 'line_note'">
                            <td colspan="99" >
                                <span t-field="line.name"/>
                            </td>
                        </t>
                    </tr>

                    <t t-if="current_section and (line_last or o.invoice_line_ids.sorted(key=lambda r: r.sequence)[line_index+1].display_type == 'line_section' or o.invoice_line_ids.sorted(key=lambda r: r.sequence)[line_index+1].display_type == 'line_note')">
                        <tr class="is-subtotal text-right">
                            <td colspan="99">
                                <strong class="mr16">Subtotal</strong>
                                <span
                                    t-esc="current_subtotal"
                                    t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                                />
                            </td>
                        </tr>
                    </t>
                </t>
            </tbody>
        </xpath>

        <xpath expr="//t[@t-foreach='o.amount_by_group']" position="replace">
            <t t-foreach="o.amount_by_group" t-as="amount_by_group">
                <tr style="">
                    <t t-if="len(o.line_ids.filtered(lambda line: line.tax_line_id)) == 1 and o.amount_untaxed == amount_by_group[2]">
                        <td>
                            <!--<span t-esc="amount_by_group[0]"/>-->
                            <span>Taxes :</span>
                        </td>
                        <td class="text-right o_price_total">
                            <span t-esc="amount_by_group[3]"/>
                        </td>
                    </t>
                    <t t-else="">
                        <td>
                            <span>Taxes :</span>
                            <!--<span t-esc="amount_by_group[0]"/>-->
                            <!--<span>&amp;nbsp;<span>on</span>-->
                                <!--<t t-esc="amount_by_group[4]"/>-->
                            <!--</span>-->
                        </td>
                        <td class="text-right o_price_total">
                            <span t-esc="amount_by_group[3]"/>
                        </td>
                    </t>
                </tr>
            </t>
        </xpath>
        <xpath expr="//tr[@class='is-subtotal text-right']" position="replace">
            <tr class="is-subtotal text-right">
                <td colspan="99">
                    <strong class="mr16">Subtotal</strong>
                    <span
                        t-esc="current_subtotal"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id,"widget": "float", "precision": 2}'
                    />
                </td>
            </tr>
        </xpath>
        <xpath expr="//div[@id='total']/div/table/tr[@class='border-black o_subtotal']" position="replace">
            <!--<t t-if="o.partner_id.is_transporter">-->
                <tr class="border-black o_subtotal" style="">
                    <td><strong>Sous-Total HT :</strong></td>
                    <td class="text-right">
                        <span t-field="o.amount_untaxed" t-options='{"widget": "float", "precision": 2}'/>&amp;nbsp;<span t-field="o.currency_id.symbol"/>
                    </td>
                </tr>
        </xpath>
        <xpath expr="//tr[@class='border-black o_total']" position="replace">
                <tr class="border-black o_total">
                    <td><strong>Total TTC :</strong></td>
                    <td class="text-right">
                        <span t-field="o.amount_total" t-options='{"widget": "float", "precision": 2}'/>&amp;nbsp;<span t-field="o.currency_id.symbol"/>
                    </td>
                </tr>
        </xpath>
        <xpath expr="//div[@name='reference']" position="replace">
           <div class="col-auto mw-100 mb-2" t-if="o.ref" name="reference">
                <strong>V/Réf :</strong>
                <p class="m-0" t-field="o.ref"/>
            </div>
        </xpath>

        <xpath expr="//div[@name='origin']" position="replace">
           <div class="col-auto mw-100 mb-2" t-if="o.invoice_origin" name="origin">
                <strong>Affaire N° :</strong>
                <p class="m-0" t-field="o.invoice_origin"/>
            </div>
        </xpath>

      <xpath expr="//span[@t-field='line.price_unit']" position="after">
          &amp;nbsp;<span t-field="o.currency_id.symbol"/>

        </xpath>

        <!--<td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">-->
            <!--<span t-field="line.price_unit" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>&amp;nbsp;<span t-field="o.currency_id.symbol"/>-->
        <!--</td>-->

        <xpath expr="//div[@t-if='o.partner_id.vat']" position="replace">

            <div t-if="o.partner_id.vat" class="mt16">
                <t t-if="o.company_id.country_id.vat_label" t-esc="o.company_id.country_id.vat_label" id="inv_tax_id_label"/>
                <t t-else="">TVA</t> : <span t-field="o.partner_id.vat"/>
            </div>
           
        </xpath>

        <xpath expr="//p[@name='payment_term']" position="after">
            <p t-if="o.payment_mode" name="payment_mode">
                <span>mode de règlement :
                    <t t-if="o.payment_mode=='virement'">
                        Virement
                    </t>
                    <t t-if="o.payment_mode=='especes'">
                        Espèces
                    </t>
                    <t t-if="o.payment_mode=='cheque'">
                        Chèque
                    </t>
                    <t t-if="o.payment_mode=='prelevement'">
                        Prélèvement
                    </t>
                </span>
            </p>           
        </xpath>

        <p t-if="o.type in ('out_invoice', 'in_refund')" position="replace">
            <p t-if="o.type in ('out_invoice', 'in_refund')">
                 Référence à rappeler lors du règlement : <b><span t-field="o.name"/></b>
            </p>
        </p>

        
    </template>
</odoo>
